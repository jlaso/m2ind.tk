<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Mastermind</title>
    <link rel="icon" type="image/ico" href="favicon.ico?v=1">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
    <link href="http://getbootstrap.com/examples/jumbotron-narrow/jumbotron-narrow.css" rel="stylesheet">
    <script src="cookies.js"></script>
    <style>
        .jumbotron .btn{
            font-size: 14px !important;
            padding: 5px 10px !important;
        }
    </style>
</head>
<body>
<div class="container col-lg-6 col-lg-offset-3">
    <div class="header clearfix">
        <nav>
            <ul class="nav nav-pills pull-right" id="tab-menu" role="tablist">
                <li role="presentation" class="active">
                    <a href="#top-ten" aria-controls="top-ten" role="tab" data-toggle="tab">Top 10</a>
                </li>
                <li role="presentation">
                    <a href="#about" aria-controls="about" role="tab" data-toggle="tab">About</a>
                </li>
                <li role="presentation">
                    <a href="#new-game" aria-controls="new-game" role="tab" data-toggle="tab">Play</a>
                </li>
            </ul>
        </nav>
        <a class="navbar-brand" rel="home" href="#" title="http://api.m2ind.tk">
            <img style="max-width:80px; margin-top: -25px;" src="logo.png">
        </a>
        <h3 class="text-muted">Mastermind</h3>
    </div>

    <div class="tab-content">

        <div role="tabpanel" class="tab-pane active" id="top-ten">
            <div class="jumbotron">
                <h1>Top 10</h1>
                <table class="table table-bordered">
                    <thead>
                    <tr>
                        <th>Rank</th>
                        <th>User</th>
                        <th>Points</th>
                        <th>Lema</th>
                    </tr>
                    </thead>
                    <tbody id="scores-table-body">

                    </tbody>
                </table>
                <p><a class="btn btn-lg btn-success" href="#" id="start_new_game" role="button">Start new game</a></p>
            </div>
        </div>

        <div role="tabpanel" class="tab-pane" id="about">
            <div class="row marketing">
                <div class="col-lg-6">
                    <h4>Github</h4>
                    <p>This little demo is a client of http://api.m2ind.tk, find more info <a href="https://github.com/jlaso/api.m2ind.tk">here</a></p>
                </div>
            </div>
        </div>

        <div role="tabpanel" class="tab-pane" id="new-game">
            <div class="jumbotron">
                <h2>Playing <span class="small" id="game_token"></span></h2>
                <table class="table table-bordered">
                    <thead>
                    <tr>
                        <th>Try #</th>
                        <th>Guess</th>
                        <th><i class="fa fa-info-circle" aria-hidden="true"></i></th>
                        <th>Result</th>
                        <th>Notes</th>
                    </tr>
                    </thead>
                    <tbody id="game-table-body">

                    </tbody>
                </table>
                <div class="clear">&nbsp;</div>
                <div class="">
                    <input type="text" name="guess" id="try" value="" placeholder="Your try?">
                    <button class="btn btn-link" id="pre_validate_try">Pre-validate</button>
                    <button class="btn btn-primary sm" id="new_try">Try</button>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    <button class="btn btn-danger btn-sm" id="ask_hint">Hint <span data-role="left_hints" class="badge"></span></button>
                </div>
                <div class="clear">&nbsp;</div>
                <div>
                    <span id="hint_0" class="label label-default" data-role="hint">0</span>
                    <span id="hint_1" class="label label-default" data-role="hint">1</span>
                    <span id="hint_2" class="label label-default" data-role="hint">2</span>
                    <span id="hint_3" class="label label-default" data-role="hint">3</span>
                    <span id="hint_4" class="label label-default" data-role="hint">4</span>
                    <span id="hint_5" class="label label-default" data-role="hint">5</span>
                    <span id="hint_6" class="label label-default" data-role="hint">6</span>
                    <span id="hint_7" class="label label-default" data-role="hint">7</span>
                    <span id="hint_8" class="label label-default" data-role="hint">8</span>
                    <span id="hint_9" class="label label-default" data-role="hint">9</span>
                </div>
            </div>
        </div>

    </div>

    <footer class="footer">
        <p>&copy; 2016 Joseluis Laso.</p>
    </footer>

</div> <!-- /container -->

<div class="modal fade" id="error_dialog" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title btn btn-danger">Error happened</h4>
            </div>
            <div class="modal-body">
                <p id="error_message">&hellip;</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Understood</button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<div class="modal fade" id="you_win_dialog" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title btn btn-success">You win, congratulations !</h4>
            </div>
            <div class="modal-body">
                <p id="error_message">Do you want to record your name with the score ?</p>
                <form class="form-inline" id="save_username">
                    <div class="form-group">
                        <label for="username">Name</label>
                        <input type="text" class="form-control" id="username" placeholder="Your nickname">
                    </div>
                    <button type="submit" class="btn btn-default">Save</button>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

</body>

<script type="text/template" id="score-row">
    <tr>
        <td>__RANK__</td>
        <td>__USER__</td>
        <td>__POINTS__</td>
        <td>__LEMA__</td>
    </tr>
</script>

<script type="text/template" id="game-row">
    <tr data-role-try="__GUESS__">
        <td>__TRY_NUM__</td>
        <td>__GUESS__</td>
        <td>
            <i class="fa fa-check-circle okay" aria-hidden="true"></i>
            <i class="fa fa-ban not_okay" aria-hidden="true"></i>
        </td>
        <td>__RESULT__</td>
        <td><input type="text"/></td>
    </tr>
</script>

<script type="text/javascript">

    //var serverUrl = "http://api.m2ind.tk/";
    var serverUrl = "http://mylocal.com:3000/";
    var numTry = 0;
    var hints = [];

    $(function(){

        $("#save_username").submit(function(e){
            e.preventDefault();
            var username = $("#username").val();
            if(username){
                saveScoreUsername(username, function(){
                    $("#you_win_dialog").modal("hide");
                    setGameToken("");
                });
            }
            return false;
        });

        $("#ask_hint").click(function(){
            askForHint();
        });

        $("#new_try").click(function(){
            var currentTry = $("#try").val();
            if(currentTry){
                postNewTry(currentTry);
            }
        });

        $("#pre_validate_try").click(function(){
            var currentTry = $("#try").val();
            if(currentTry){
                preValidateTry(currentTry);
            }
        });

        $("#start_new_game").click(function(e){
            $('#tab-menu a[href="#new-game"]').click()
        });

        $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
            if ("#new-game" == e.target.hash) {
                if (!getGameToken()) {
                    startNewGame(function(){
                        showGameToken();
                    });
                }else{
                    showGameToken();
                    getTriesForGame();
                    getHints();
                }
            }
        });

        // behaviour for the tab navbar
        $('#tab-menu a').click(function (e) {
            e.preventDefault();
            $(this).tab('show');
        });

        // updates the top-10 scores table
        getScores();

        // check if the gameToken stored in cookies is already finished
        validateGameToken();
    });

    /** GAME VARIABLES **/

    /**
     * stores the gameToken in cookie
     */
    function setGameToken(token)
    {
        setCookie("game_token", token);
    }

    /**
     * gets the gameToken stored in cookie
     */
    function getGameToken()
    {
        return getCookie("game_token");
    }

    /**
     * store the scoredId in cookie
     */
    function setScoreId(id)
    {
        setCookie("score_id", id);
    }

    /**
     * gets the scoreId stored in cookie
     */
    function getScoreId()
    {
        return getCookie("score_id");
    }

    /**
     * renders a template of type <script type="text/template" id="templateId">...
     * @param templateId
     * @param data
     * Example {
     *   "id": 1234,            // ==> in template should be __ID__
     *   "name": "the name"     // in the template should be __NAME__
     * }
     */
    function renderTemplate(templateId, data){
        var html = $(templateId).html();
        for(i in data){
            if(data.hasOwnProperty(i)){
                item = data[i];
                html = html.replace(new RegExp("__"+i.toUpperCase()+"__", 'g'), item);
            }
        }
        return html;
    }

    /**
     * shows the gameToken in the span allowed for that
     */
    function showGameToken()
    {
        $("#game_token").html(getGameToken());
    }

    /**
     * checks that the gameToken store in cookie is valid (already finished or invented)
     */
    function validateGameToken()
    {
        var game_token = getGameToken();
        if(!game_token) return;

        $.ajax({
            method: "get",
            url: serverUrl+"scores/"+game_token,
            error: function(data){
                console.error(data);
            }
        }).done(function(item){
            if(item && item.user) {
                setGameToken("");
            }else{
                console.log(item);
            }
        });
    }

    /**
     * sends guess/try to the server and process the result
     */
    function postNewTry(guessValue)
    {
        $.ajax({
            method: "post",
            data: {
                game_token: getGameToken(),
                "try":  guessValue
            },
            url: serverUrl+"game_tries",
            error: function(data){
                if (data.responseJSON) {
                    showErrorMessage(data.responseJSON.error);
                }else{
                    console.error(data);
                }
            }
        }).done(function(item){
            var content = renderTemplate("#game-row", {
                try_num: numTry,
                guess: item.try,
                result: item.result
            });
            $("#game-table-body").append(content);
            hideTriesHelp();
            numTry++;
            if (item.hint){
                addHint(item.hint);
            }
            if (item.you_win) {
                setScoreId(item.score);
                $("#you_win_dialog").modal();
            }
        });
    }

    /**
     * starts a new game
     */
    function startNewGame(callback){
        $.ajax({
            method: "post",
            data: { num_pos: 5 },
            url: serverUrl+'games'
        }).done(function(data){
            if(data.token){
                setGameToken(data.token);
                if (callback) callback(data.token);
            }else{
                console.error(data);
            }
        })
    }

    function saveScoreUsername(username, callback)
    {
        $.ajax({
            method: "put",
            data: {
                game_token: getGameToken(),
                user: username
            },
            url: serverUrl+"scores/"+getScoreId(),
            error: function(data){
                console.error(data);
            }
        }).done(function(data){
            if(data.success == undefined){
                console.error("some error happened");
            }
            if (callback) {
                callback();
            }
        });
    }

    function getTriesForGame(){
        $.ajax({
            method: 'get',
            data: { game_token: getGameToken() },
            url: serverUrl+"game_tries.json",
            error: function(data){
                console.error(data);
            }
        }).done(function(data){
            numTry = 1;
            for(var i=0; i<data.length; i++){
                item = data[i];
                var content = renderTemplate("#game-row", {
                    try_num: numTry,
                    guess: item.try,
                    result: item.result
                });
                $("#game-table-body").append(content);
                numTry++;
            }
            hideTriesHelp();
        })
    }

    function preValidateTry(newTry){
        $.ajax({
            method: 'get',
            data: {
                game_token: getGameToken(),
                check_try: newTry
            },
            url: serverUrl+"game_tries.json",
            error: function(data){
                console.error(data);
            }
        }).done(function(data){
            hideTriesHelp();
            for(i in data){
                item = data[i];
                var okay = item.result && item.matches;
                var path = '[data-role-try="'+item.try+'"] .'+(okay ? "okay" : "not_okay");
                $(path).show();
            }
        })
    }

    function hideTriesHelp()
    {
        $(".okay").hide();
        $(".not_okay").hide();
    }

    function showHints()
    {
        $('[data-role="hint"]').removeClass("label-success");
        for(var i = 0; i < hints.length; i++){
            hint = hints[i];
            $("#hint_"+hint).addClass("label-success");
        }
    }

    function addHint(hint)
    {
        if(-1 == hints.indexOf(hint)){
            hints.push(hint);
            showHints();
        }
    }

    function askForHint()
    {
        $.ajax({
            method: "post",
            data: { game_token: getGameToken() },
            url: serverUrl+'game_hints'
        }).done(function(data){
            if(data.success){
                addHint(data.hint);
                updateLeftHints(data.hints_left);
            }else{
                if (data.responseJSON) {
                    showErrorMessage(data.responseJSON.error);
                }else{
                    console.error(data);
                }
            }
        })
    }

    function getHints()
    {
        $.ajax({
            method: "get",
            data: { game_token: getGameToken() },
            url: serverUrl+'game_hints'
        }).done(function(data){
            if(data.success){
                hints = data.hints;
                showHints();
                updateLeftHints(data.hints_left);
            }else{
                if (data.responseJSON) {
                    showErrorMessage(data.responseJSON.error);
                }else{
                    console.error(data);
                }
            }
        })
    }

    function updateLeftHints(leftHints)
    {
        $("#left_hints").html(leftHints);
    }

    function showErrorMessage(message)
    {
        $("#error_message").html(message);
        $('#error_dialog').modal();
    }

    function getScores(){
        $.ajax({
            method: 'get',
            data: {},
            url: serverUrl+"scores.json",
            error: function(data){
                alert(data)
            }
        }).done(function(data){
            var rank = 1;
            for(i in data){
                item = data[i];
                var content = renderTemplate("#score-row", {
                    rank: rank,
                    user: item.user,
                    points: item.points,
                    lema: item.tries+' tries on '+Math.round(item.seconds/60)+' minutes'
                });
                $("#scores-table-body").append(content);
                rank++;
            }
        })
    }

</script>
</html>
